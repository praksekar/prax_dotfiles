#!/usr/bin/env bash

# when deploying on new machine remember to add these lines to /etc/udev/rules.d/backlight.rules
#ACTION=="add", SUBSYSTEM=="backlight", KERNEL=="acpi_video0", RUN+="/bin/chgrp video /sys/class/backlight/%k/brightness"
#ACTION=="add", SUBSYSTEM=="backlight", KERNEL=="acpi_video0", RUN+="/bin/chmod g+w /sys/class/backlight/%k/brightness"
# after, add user prakash to video group. changes only take effect after reboot.

case "$1" in
    keyboard)
        case "$2" in
            off) brightness=0 ;;
            on) brightness=127 ;;
            max) brightness=255 ;;
            *) echo "invalid argument"; exit 1 ;;
        esac

        echo "$brightness" | sudo tee /sys/class/leds/kbd_backlight/brightness
        notify-send "Keyboard Brightness = $brightness"
    ;;

    laptop)
        brightness=$(cat /sys/class/backlight/intel_backlight/brightness)
        max_brightness=$(cat /sys/class/backlight/intel_backlight/max_brightness)
        increment=1000

        case "$2" in
            inc) brightness=$(($brightness+$increment)) ;;
            dec) brightness=$(($brightness-$increment)) ;;
            *) brightness=$2
        esac

        if (($brightness > $max_brightness)); then brightness=$max_brightness; fi
        if (($brightness < 1000)); then brightness=1000; fi

        echo "$brightness" | tee /sys/class/backlight/intel_backlight/brightness 
        notify-send "Laptop Brightness = $brightness"
    ;;
    
    monitor)
        brightness=$(cat ~/Dotfiles/system_scripts/usr/bin/monitor_brightness)
        increment=1

        case "$2" in 
            inc) brightness=$(($brightness+$increment));;
            dec) brightness=$(($brightness-$increment));;
            *) echo "invalid argument"; exit 1;;
        esac

        if (($brightness > 10)); then brightness=10; fi
        if (($brightness < 1)); then brightness=1; fi

        echo "$brightness" > ~/Dotfiles/system_scripts/usr/bin/monitor_brightness
        notify-send --expire-time=500 "Monitor Brightness = $brightness"
        xrandr --output "$MONITOR_SECONDARY" --brightness $(echo $brightness*0.1 | bc)
    ;;

    *) echo "Error: first arg must be keyboard, laptop, monitor, second arg must be inc/dec" ;;
esac

